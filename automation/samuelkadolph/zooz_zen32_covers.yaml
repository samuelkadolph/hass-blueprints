blueprint:
  name: Zooz ZEN32 Covers
  description: Control covers with a Zooz ZEN32 scene controller.
  domain: automation
  author: Samuel Kadolph
  source_url: https://github.com/samuelkadolph/hass-blueprints/blob/main/automation/samuelkadolph/zooz_zen32_covers.yaml
  input:
    covers:
      name: Covers
      description: Which covers to control?
      selector:
        entity:
          domain: cover
          multiple: true
    controller:
      name: Controller
      description: Which scene controller to use?
      selector:
        device:
          filter:
          - { manufacturer: Zooz, model: ZEN32 }
    key:
      name: Key
      default: '005'
      description: Which button on the controller to use?
      selector:
        select:
          mode: dropdown
          options:
          - label: '1 (Top)'
            value: '005'
          - label: '2 (Mid Left)'
            value: '001'
          - label: '3 (Mid Right)'
            value: '002'
          - label: '4 (Bottom Left)'
            value: '003'
          - label: '5 (Bottom Right)'
            value: '004'
    state_variable:
      name: State Variable
      description: |
        This automation requires a Number helper to store the current state of the shade.
        Please create one that goes from 0 to 4 and select it here.
        Must only be shared with automations using the same set of shades.
      selector:
        entity:
          domain: input_number
    idle_timeout:
      name: Idle Timeout
      description: How long to wait before resetting the control state?
      default: { seconds: 30 }
      selector:
        duration:
    led_enable:
      name: Enable LED
      description: Use the LED to show the state of the lights?
      default: true
      selector:
        boolean:
    led_invert:
      name: Invert LED
      description: Invert the LED state?
      default: false
      selector:
        boolean:

mode: single
max_exceeded: silent

triggers:
- trigger: state
  attribute: current_position
  entity_id: !input covers
  for: !input idle_timeout
  id: reset
- trigger: state
  entity_id: !input covers
  to: open
  id: cover_opened
- trigger: state
  entity_id: !input covers
  to: closed
  id: cover_closed
- trigger: event
  event_type: zwave_js_value_notification
  event_data:
    device_id: !input controller
    command_class_name: Central Scene
    property_key: !input key
  id: key_event


variables:
  controller: !input controller
  event: '{{ trigger.event.data.value if trigger.id == "key_event" else None }}'
  key: !input key
  led_enable: !input led_enable
  led_invert: !input led_invert
  led_off_value: '{{ led_invert and 3 or 2 }}'
  led_on_value: '{{ led_invert and 2 or 3 }}'
  led_param: '{{ int(key) % 5 + 1 }}'
  state_variable: !input state_variable
  state: '{{ int(states(state_variable)) }}'
  # 0=nothing 1=opening 2=opening_stopped 3=closing 4=closing_stopped

actions:
- choose:
  - conditions:
    - '{{ trigger.id == "reset" }}'
    sequence:
    - action: input_number.set_value
      data: { value: 0 }
      target: { entity_id: !input state_variable }

  - conditions:
    - '{{ trigger.id == "cover_opened" }}'
    sequence: &led_on
    - if:
      - '{{ led_enable }}'
      then:
      - action: zwave_js.set_config_parameter
        data: { parameter: '{{ led_param }}', value: '{{ led_on_value }}' }
        target: { device_id: '{{ controller }}' }

  - conditions:
    - '{{ trigger.id == "cover_closed" }}'
    sequence: &led_off
    - if:
      - '{{ led_enable }}'
      then:
      - action: zwave_js.set_config_parameter
        data: { parameter: '{{ led_param }}', value: '{{ led_off_value }}' }
        target: { device_id: '{{ controller }}' }

  - conditions:
    - '{{ trigger.id == "key_event" and event in ["KeyPressed", "KeyPressed2x"] }}'
    sequence:
    - choose:
      - conditions:
        - '{{ state == 0 }}'
        sequence: &open_or_close_covers
        - if:
          - condition: state
            entity_id: !input covers
            state: '{{ event == "KeyPressed2x" and "open" or "closed" }}'
          then: &open_covers
          - action: cover.open_cover
            target: { entity_id: !input covers }
          - action: input_number.set_value
            data: { value: 1 }
            target: { entity_id: !input state_variable }
          - <<: *led_on
          else: &close_covers
          - action: cover.close_cover
            target: { entity_id: !input covers }
          - action: input_number.set_value
            data: { value: 3 }
            target: { entity_id: !input state_variable }
          - <<: *led_off
      - conditions:
        - '{{ state == 1 }}'
        sequence: &stop_opening
        - action: cover.stop_cover
          target: { entity_id: !input covers }
        - action: input_number.set_value
          data: { value: 2 }
          target: { entity_id: !input state_variable }
      - conditions:
        - '{{ state == 2 }}'
        sequence: *close_covers
      - conditions:
        - '{{ state == 3 }}'
        sequence: &stop_closing
        - action: cover.stop_cover
          target: { entity_id: !input covers }
        - action: input_number.set_value
          data: { value: 4 }
          target: { entity_id: !input state_variable }
      - conditions:
        - '{{ state == 4 }}'
        sequence: *open_covers

  - conditions:
    - '{{ trigger.id == "key_event" and event == "KeyHeldDown" }}'
    sequence:
    - choose:
      - conditions:
        - '{{ state == 0 }}'
        sequence: *open_or_close_covers
      - conditions:
        - '{{ state in [1, 2] }}'
        sequence: *close_covers
      - conditions:
        - '{{ state in [3, 4] }}'
        sequence: *open_covers

  - conditions:
    - '{{ trigger.id == "key_event" and event == "KeyReleased" }}'
    sequence:
    - choose:
      - conditions:
        - '{{ state == 1 }}'
        sequence: *stop_opening
      - conditions:
        - '{{ state == 3 }}'
        sequence: *stop_closing
